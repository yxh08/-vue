{
  "version": 3,
  "sources": ["../src/effect.ts", "../src/system.ts", "../src/ref.ts", "../src/reactive.ts"],
  "sourcesContent": ["export let activeSub: ReactivityEffect\n\nexport function effect(fn: Function, effectOptions: {}) {\n  const e = new ReactivityEffect(fn)\n  Object.assign(e, effectOptions)\n  e.run()\n  const runner = () => e.run()\n  runner.effect = e\n  return runner\n}\n\nimport type { Link } from './system'\n\nexport class ReactivityEffect {\n  deps: Link | undefined = undefined\n  depsTail: Link | undefined = undefined\n  tracking: Boolean = false\n  constructor(public fn: Function) {}\n  run() {\n    if (this.tracking) return\n    this.tracking = true\n    const prevActiveSub = activeSub\n    try {\n      this.depsTail = undefined\n      activeSub = this\n      return this.fn() //return effect\u7684return\n    } finally {\n      activeSub = prevActiveSub\n      this.tracking = false\n      // console.count('\u4F9D\u8D56\u6536\u96C6\u6B21\u6570')\n\n      //\u6E05\u7406dep\n      if (this.depsTail) {\n        endTrack(this)\n      }\n      // console.log('\u6E05\u7406deps', this)\n    }\n  }\n  scheduler() {\n    this.run()\n  }\n  notify() {\n    this.scheduler()\n  }\n}\n\nconst endTrack = sub => {\n  console.log('sub', sub)\n  let link = sub.depsTail?.nextDep\n  // sub?.depsTail.nextDep ??= undefined\n  if (link) {\n    clearDep(link)\n  }\n}\nconst clearDep = link => {\n  //\u4E34\u65F6\u53D8\u91CF \u4FDD\u5B58\u5F53\u524D\u8282\u70B9\u5C5E\u6027\u7684\u6307\u5411\n  const { sub, nextSub, prevSub, dep, nextDep } = link\n  /**\n   * subs\u5904\u7406\n   *  \u89E3\u51B3deps\u4E2D\u672A\u6CA1\u6709\u7684dep\u7684set\u89E6\u53D1effect\u6267\u884C\u95EE\u9898\n   * 1.\u64CD\u4F5CprevSub\u8282\u70B9\u7684nextSub\u6307\u5411\u5F53\u524D\u8282\u70B9\u7684\u4E0B\u4E00\u4E2A,\n   * 2.\u64CD\u4F5CnextSub\u8282\u70B9\u7684prevSub\u6307\u5411\u5F53\u524D\u8282\u70B9\u7684\u4E0A\u4E00\u4E2A,\n   * 3.\u5F53\u524D\u8282\u70B9\u7684dep\u548Csub \u6307\u5411undefined\n   */\n  if (prevSub) {\n    prevSub.nextSub = nextSub\n    //\u6E05\u9664\u81EA\u8EABprevSub\u7684\u6307\u5411\n    link.prevSub = undefined\n  } else {\n    //\u81EA\u8EAB\u4E3A\u5934\u8282\u70B9\u7684\u5904\u7406\n    dep.subs = nextSub\n  }\n\n  if (nextSub) {\n    nextSub.prevSub = prevSub\n    link.nextSub = undefined\n  } else {\n    //\u81EA\u8EAB\u4E3A\u5C3E\u8282\u70B9\u7684\u5904\u7406\n    dep.subsTail = prevSub\n  }\n\n  //deps\u5904\u7406,\u65AD\u5F00nextDep\u7684\u6307\u5411\n  link.nextDep = undefined\n\n  //\u6E05\u9664\u81EA\u8EAB\u7684dep\u548Csub\u6307\u5411\n  link.dep = link.sub = undefined\n\n  if (nextDep) {\n    clearDep(nextDep)\n  }\n}\n", "//\u4F9D\u8D56\u9879\nimport { ReactivityEffect } from './effect'\n\nexport interface Dependcy {\n  subs: Link\n  subsTail: Link | undefined\n}\n//\u4F9D\u8D56\u9879\nexport interface Sub extends ReactivityEffect {\n  deps: Link\n  depsTail: Link | undefined\n}\n\nexport interface Link {\n  sub: Sub\n  nextSub: Link | undefined\n  prevSub: Link | undefined\n  dep: Dependcy\n  nextDep: Link | undefined\n}\n\n//\u4F9D\u8D56\u6536\u96C6 \u4E0E \u5206\u652F\u5207\u6362\n\n/**\n *  @Param dep \u4F9D\u8D56\u9879 RefImpl\n *  @Param sub \u8BA2\u9605\u8005 ReactivityEffect\n */\nexport const collect = (dep, sub) => {\n  /**\n   * \u907F\u514D\u4F9D\u8D56\u91CD\u590D\u6536\u96C6\n   *  \u5982\u679Csub.deps\u5B58\u5728\u5E76\u4E14sub.depsTail = undefined\n   *   \u90A3\u4E48\u5C31\u662F\u518D\u6B21\u6267\u884Crun(\u7B2C\u4E00\u6B21\u7684\u65F6\u5019\u5DF2\u7ECF\u6536\u96C6\u8FC7\u4E00\u904D\u4F9D\u8D56),\n   *    \u9700\u8981\u5224\u65AD\u4E00\u4E0B\u662F\u5426\u662F\u91CD\u590D\u6536\u96C6\u4F9D\u8D56(\u6709\u53EF\u80FD\u662F\u5206\u652F\u5207\u6362,\u9700\u8981\u7684\u4F9D\u8D56\u4E0D\u540C)\n   */\n\n  const currentDep =\n    sub.deps && sub.depsTail == undefined ? sub.deps : sub.depsTail\n  // console.log(dep)\n  // \u4F9D\u8D56\u6536\u96C6\n  if (sub.deps && sub.depsTail == undefined) {\n    //\u518D\u6B21\u6536\u96C6\u5934\u8282\u70B9\n    if (currentDep.dep == dep) {\n      // console.log('\u590D\u7528\u8282\u70B9', currentDep)\n      sub.depsTail = currentDep\n      return\n    }\n  } else {\n    // console.log('\u672A\u590D\u7528\u7684\u8282\u70B9', currentDep)\n  }\n\n  const newLink: Link = {\n    sub,\n    prevSub: undefined,\n    nextSub: undefined,\n    dep,\n    nextDep: currentDep?.nextDep,\n  }\n\n  if (!sub.deps) {\n    sub.deps = newLink\n    sub.depsTail = newLink\n  } else {\n    sub.depsTail.nextDep = newLink\n    sub.depsTail = newLink\n  }\n\n  if (!dep.subs) {\n    dep.subs = newLink\n    dep.subsTail = newLink\n  } else {\n    dep.subsTail!.nextSub = newLink\n    newLink.prevSub = dep.subsTail\n    dep.subsTail = newLink\n  }\n}\n\n//\u89E6\u53D1\u4F9D\u8D56\nexport const trigger = (dep: any) => {\n  if (dep.subs) {\n    let curSub: Link | undefined = dep.subs\n    let queue: ReactivityEffect[] = []\n    while (curSub?.sub) {\n      queue.push(curSub.sub as ReactivityEffect)\n      curSub = curSub.nextSub\n    }\n    console.log('\u5F85\u6267\u884C\u961F\u5217', queue)\n    for (let i = 0; i <= queue.length - 1; i++) {\n      queue[i].notify()\n    }\n  }\n}\n", "import { activeSub, ReactivityEffect } from './effect';\nimport { collect, trigger } from './system';\nimport { Link } from './system';\nexport const ref = (value: any) => {\n  return new RefImpl(value);\n};\nexport class RefImpl {\n  subs: Link | undefined;\n  subsTail: Link | undefined;\n  constructor(public _value: any) {}\n  get value() {\n    //\u6536\u96C6\u4F9D\u8D56\n    // console.log('\u6536\u96C6\u4F9D\u8D56',activeSub)\n    if (activeSub) {\n      collect(this, activeSub);\n    }\n    return this._value;\n  }\n  set value(newValue) {\n    this._value = newValue;\n    //\u89E6\u53D1\u4F9D\u8D56\n    // console.log('\u89E6\u53D1\u4F9D\u8D56')\n    trigger(this);\n  }\n}\n", "import { collect, Link, trigger } from './system'\nimport { activeSub } from './effect'\n\nexport function reactive(target: any) {\n  //TODO\n  // if (!Object.is(target)) {\n  //   return target\n  // }\n  return createReactiveObject(target)\n}\n\nexport interface Dep {\n  subs: Link | undefined\n  subsTail: Link | undefined\n}\n\nexport class Dep {\n  subs: Link | undefined\n  subsTail: Link | undefined\n  constructor() {\n    this.subs = undefined\n    this.subsTail = undefined\n  }\n}\n\nconst targetMap = new WeakMap()\n\nfunction createReactiveObject(target) {\n  return new Proxy(target, {\n    get(target, key, receiver) {\n      let keyMap = targetMap.get(target)\n      if (!keyMap) {\n        targetMap.set(target, (keyMap = new Map()))\n      }\n      let dep = keyMap.get(key)\n\n      if (!dep) {\n        keyMap.set(key, (dep = new Dep()))\n      }\n      console.log('dep', dep)\n      if (activeSub) {\n        collect(dep, activeSub)\n      }\n\n      return Reflect.get(target, key)\n    },\n    set(target, key, newValue, receiver) {\n      const res = Reflect.set(target, key, newValue)\n\n      let keyMap = targetMap.get(target)\n      if (!keyMap) {\n        targetMap.set(target, (keyMap = new Map()))\n      }\n      let dep = keyMap.get(key)\n\n      if (!dep) {\n        keyMap.set(key, (dep = new Dep()))\n      }\n      console.log('dep', dep)\n      trigger(dep)\n      return newValue\n    },\n  })\n}\n"],
  "mappings": "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",
  "names": ["target"]
}

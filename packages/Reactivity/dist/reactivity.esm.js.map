{
  "version": 3,
  "sources": ["../src/effect.ts", "../src/system.ts", "../src/ref.ts"],
  "sourcesContent": ["export let activeSub: ReactivityEffect;\r\n\r\nexport  function effect (fn: Function, effectOptions: {}) {\r\n  const e = new ReactivityEffect(fn);\r\n  Object.assign(e, effectOptions);\r\n  e.run();\r\n  const runner = () => e.run()\r\n  runner.effect = e;\r\n  return runner;\r\n};\r\n\r\nimport type { Link } from './system';\r\n\r\nexport class ReactivityEffect {\r\n  deps: Link | undefined;\r\n  depsTail: Link | undefined;\r\n  constructor(public fn: Function) {}\r\n\r\n  run() {\r\n    const prevActiveSub = activeSub;\r\n    try {\r\n      this.depsTail = undefined\r\n      activeSub = this;\r\n      this.fn();\r\n    } finally {\r\n      activeSub = prevActiveSub;\r\n    }\r\n  }\r\n  scheduler() {\r\n    this.run();\r\n  }\r\n  notify() {\r\n    this.scheduler();\r\n  }\r\n}\r\n", "//\u4F9D\u8D56\u9879\nimport { ReactivityEffect } from './effect'\n\nexport interface Dep {\n  subs: Link\n  subsTail: Link | undefined\n}\n//\u4F9D\u8D56\u9879\nexport interface Sub extends ReactivityEffect {\n  deps: Link\n  depsTail: Link | undefined\n}\n\nexport interface Link {\n  sub: Sub\n  nextSub: Link | undefined\n  prevSub: Link | undefined\n  dep: Dep\n  nextDep: Link | undefined\n}\n\n//\u4F9D\u8D56\u6536\u96C6 \u4E0E \u5206\u652F\u5207\u6362\n\n/**\n *  @Param dep \u4F9D\u8D56\u9879 RefImpl\n *  @Param sub \u8BA2\u9605\u8005 ReactivityEffect\n */\nexport const collect = (dep, sub) => {\n  /**\n   * \u907F\u514D\u4F9D\u8D56\u91CD\u590D\u6536\u96C6\n   *  \u5982\u679Csub.deps\u5B58\u5728\u5E76\u4E14sub.depsTail = undefined\n   *   \u90A3\u4E48\u5C31\u662F\u518D\u6B21\u6267\u884Crun(\u7B2C\u4E00\u6B21\u7684\u65F6\u5019\u5DF2\u7ECF\u6536\u96C6\u8FC7\u4E00\u904D\u4F9D\u8D56),\n   *    \u9700\u8981\u5224\u65AD\u4E00\u4E0B\u662F\u5426\u662F\u91CD\u590D\u6536\u96C6\u4F9D\u8D56(\u6709\u53EF\u80FD\u662F\u5206\u652F\u5207\u6362,\u9700\u8981\u7684\u4F9D\u8D56\u4E0D\u540C)\n   */\n\n  const currentDep =\n    sub.deps && sub.depsTail == undefined ? sub.deps : sub.depsTail?.nextDep\n  // console.log('currentDep',currentDep)\n  if (sub.deps && currentDep?.dep == dep) {\n    //\u8282\u70B9\u5BF9\u6BD4\u590D\u7528\n    // console.log('\u590D\u7528\u8282\u70B9', currentDep);\n    sub.depsTail = currentDep\n    return\n  } else {\n    console.log('\u672A\u88AB\u590D\u7528\u7684dep', currentDep)\n  }\n  // \u4F9D\u8D56\u6536\u96C6\n  const newLink: Link = {\n    sub,\n    prevSub: undefined,\n    nextSub: undefined,\n    dep,\n    nextDep: undefined,\n  }\n\n  if (!sub.deps) {\n    sub.deps = newLink\n    sub.depsTail = newLink\n  } else {\n    sub.deps.nextDep = newLink\n    sub.depsTail = newLink\n  }\n\n  if (!dep.subs) {\n    dep.subs = newLink\n    dep.subsTail = newLink\n  } else {\n    dep.subsTail!.nextSub = newLink\n    newLink.prevSub = dep.subsTail\n    dep.subsTail = newLink\n  }\n}\n\n//\u89E6\u53D1\u4F9D\u8D56\nexport const trigger = (dep: any) => {\n  if (dep.subs) {\n    let curSub: Link | undefined = dep.subs\n    let queue: ReactivityEffect[] = []\n    while (curSub?.sub) {\n      queue.push(curSub.sub as ReactivityEffect)\n      curSub = curSub.nextSub\n    }\n    // console.log('\u5F85\u6267\u884C\u961F\u5217', queue);\n    for (let i = 0; i <= queue.length - 1; i++) {\n      queue[i].notify()\n    }\n  }\n}\n", "import { activeSub, ReactivityEffect } from './effect';\r\nimport { collect, trigger } from './system';\r\nimport { Link } from './system';\r\nexport const ref = (value: any) => {\r\n  return new RefImpl(value);\r\n};\r\nexport class RefImpl {\r\n  subs: Link | undefined;\r\n  subsTail: Link | undefined;\r\n  constructor(public _value: any) {}\r\n  get value() {\r\n    //\u6536\u96C6\u4F9D\u8D56\r\n    // console.log('\u6536\u96C6\u4F9D\u8D56',activeSub)\r\n    if (activeSub) {\r\n      collect(this, activeSub);\r\n    }\r\n    return this._value;\r\n  }\r\n  set value(newValue) {\r\n    this._value = newValue;\r\n    //\u89E6\u53D1\u4F9D\u8D56\r\n    // console.log('\u89E6\u53D1\u4F9D\u8D56')\r\n    trigger(this);\r\n  }\r\n}\r\n"],
  "mappings": ";AAAO,IAAI;AAEH,SAAS,OAAQ,IAAc,eAAmB;AACxD,QAAM,IAAI,IAAI,iBAAiB,EAAE;AACjC,SAAO,OAAO,GAAG,aAAa;AAC9B,IAAE,IAAI;AACN,QAAM,SAAS,MAAM,EAAE,IAAI;AAC3B,SAAO,SAAS;AAChB,SAAO;AACT;AAIO,IAAM,mBAAN,MAAuB;AAAA,EAG5B,YAAmB,IAAc;AAAd;AAAA,EAAe;AAAA,EAElC,MAAM;AACJ,UAAM,gBAAgB;AACtB,QAAI;AACF,WAAK,WAAW;AAChB,kBAAY;AACZ,WAAK,GAAG;AAAA,IACV,UAAE;AACA,kBAAY;AAAA,IACd;AAAA,EACF;AAAA,EACA,YAAY;AACV,SAAK,IAAI;AAAA,EACX;AAAA,EACA,SAAS;AACP,SAAK,UAAU;AAAA,EACjB;AACF;;;ACPO,IAAM,UAAU,CAAC,KAAK,QAAQ;AAQnC,QAAM,aACJ,IAAI,QAAQ,IAAI,YAAY,SAAY,IAAI,OAAO,IAAI,UAAU;AAEnE,MAAI,IAAI,QAAQ,YAAY,OAAO,KAAK;AAGtC,QAAI,WAAW;AACf;AAAA,EACF,OAAO;AACL,YAAQ,IAAI,qCAAY,UAAU;AAAA,EACpC;AAEA,QAAM,UAAgB;AAAA,IACpB;AAAA,IACA,SAAS;AAAA,IACT,SAAS;AAAA,IACT;AAAA,IACA,SAAS;AAAA,EACX;AAEA,MAAI,CAAC,IAAI,MAAM;AACb,QAAI,OAAO;AACX,QAAI,WAAW;AAAA,EACjB,OAAO;AACL,QAAI,KAAK,UAAU;AACnB,QAAI,WAAW;AAAA,EACjB;AAEA,MAAI,CAAC,IAAI,MAAM;AACb,QAAI,OAAO;AACX,QAAI,WAAW;AAAA,EACjB,OAAO;AACL,QAAI,SAAU,UAAU;AACxB,YAAQ,UAAU,IAAI;AACtB,QAAI,WAAW;AAAA,EACjB;AACF;AAGO,IAAM,UAAU,CAAC,QAAa;AACnC,MAAI,IAAI,MAAM;AACZ,QAAI,SAA2B,IAAI;AACnC,QAAI,QAA4B,CAAC;AACjC,WAAO,QAAQ,KAAK;AAClB,YAAM,KAAK,OAAO,GAAuB;AACzC,eAAS,OAAO;AAAA,IAClB;AAEA,aAAS,IAAI,GAAG,KAAK,MAAM,SAAS,GAAG,KAAK;AAC1C,YAAM,CAAC,EAAE,OAAO;AAAA,IAClB;AAAA,EACF;AACF;;;ACpFO,IAAM,MAAM,CAAC,UAAe;AACjC,SAAO,IAAI,QAAQ,KAAK;AAC1B;AACO,IAAM,UAAN,MAAc;AAAA,EAGnB,YAAmB,QAAa;AAAb;AAAA,EAAc;AAAA,EACjC,IAAI,QAAQ;AAGV,QAAI,WAAW;AACb,cAAQ,MAAM,SAAS;AAAA,IACzB;AACA,WAAO,KAAK;AAAA,EACd;AAAA,EACA,IAAI,MAAM,UAAU;AAClB,SAAK,SAAS;AAGd,YAAQ,IAAI;AAAA,EACd;AACF;",
  "names": []
}
